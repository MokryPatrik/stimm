services:
  whisper-stt:
    build:
      context: ../../src/whisper.local
      dockerfile: ../../docker/whisper-stt/Dockerfile
    container_name: whisper-stt
    gpus: all
    volumes:
      - ../../src/whisper.local:/app
      - whisper_models:/models
    environment:
      - WHISPER_MODEL_ID=${WHISPER_MODEL_ID:-Systran/faster-whisper-medium}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-cuda}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-float16}
      - WHISPER_STREAM_SAMPLE_RATE=${WHISPER_STREAM_SAMPLE_RATE:-16000}
      - WHISPER_STREAM_MIN_BUFFER_MS=${WHISPER_STREAM_MIN_BUFFER_MS:-600}
      - WHISPER_STREAM_UPDATE_MS=${WHISPER_STREAM_UPDATE_MS:-400}
      - WHISPER_STREAM_HISTORY_MS=${WHISPER_STREAM_HISTORY_MS:-6000}
      - WHISPER_STREAM_ENERGY_THRESHOLD=${WHISPER_STREAM_ENERGY_THRESHOLD:-650}
      - WHISPER_STREAM_MIN_SPEECH_MS=${WHISPER_STREAM_MIN_SPEECH_MS:-600}
      - WHISPER_STREAM_SILENCE_MS=${WHISPER_STREAM_SILENCE_MS:-800}
      - WHISPER_STREAM_MAX_SEGMENT_MS=${WHISPER_STREAM_MAX_SEGMENT_MS:-6000}
      - WHISPER_STREAM_INTERIM_BEAM_SIZE=${WHISPER_STREAM_INTERIM_BEAM_SIZE:-1}
      - WHISPER_STREAM_FINAL_BEAM_SIZE=${WHISPER_STREAM_FINAL_BEAM_SIZE:-3}
      - WHISPER_STREAM_ENABLE_INTERIMS=${WHISPER_STREAM_ENABLE_INTERIMS:-true}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
      - LOG_LEVEL=${WHISPER_LOG_LEVEL:-INFO}
    ports:
      - "8003:8003"
    networks:
      - voicebot-network
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8003", "--reload"]

volumes:
  whisper_models:

networks:
  voicebot-network:
    external: true
