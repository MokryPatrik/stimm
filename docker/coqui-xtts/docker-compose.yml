services:
  coqui-xtts:
    build:
      context: ../../docker/coqui-xtts
      dockerfile: Dockerfile
    container_name: coqui-xtts
    ports:
      - "${COQUI_SPEECH_PORT:-5010}:5000"  # REST API
      - "${COQUI_WS_SPEECH_PORT:-5011}:5001"  # WebSocket API
    environment:
      - LOG_LEVEL=${COQUI_LOG_LEVEL:-INFO}
      - COQUI_TTS_MODEL_ID=${COQUI_TTS_MODEL_ID:-tts_models/multilingual/multi-dataset/xtts_v2}
      - COQUI_TTS_DEFAULT_LANGUAGE=${COQUI_TTS_DEFAULT_LANGUAGE:-fr}
      - COQUI_TTS_DEFAULT_SPEAKER=${COQUI_TTS_DEFAULT_SPEAKER:-Ana Florence}
      - COQUI_TTS_DEVICE=${COQUI_TTS_DEVICE:-cuda}
      - COQUI_TTS_DTYPE=${COQUI_TTS_DTYPE:-float16}
      - COQUI_TTS_SEGMENT_MAX_CHARS=${COQUI_TTS_SEGMENT_MAX_CHARS:-140}
      - COQUI_TTS_SEGMENT_MIN_CHARS=${COQUI_TTS_SEGMENT_MIN_CHARS:-60}
      - COQUI_TTS_REFERENCE_WAV=${COQUI_TTS_REFERENCE_WAV:-}
      - COQUI_TTS_STYLE_WAV=${COQUI_TTS_STYLE_WAV:-}
      - COQUI_CACHE_DIR=/models/cache
      - HF_HOME=/models/huggingface
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN:-}
      - NVIDIA_VISIBLE_DEVICES=all
      - COQUI_WS_ENABLED=true
    volumes:
      - coqui_speech_models:/models
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
